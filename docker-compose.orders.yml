services:
  orders-migrate:
    build:
      context: .
      dockerfile: services/orders/Dockerfile
      target: orders-migrate
    environment:
      DATABASE_URL: postgres://goshop:goshop@postgres16:5432/goshop?sslmode=disable&search_path=orders,public
      RETRIES: "120"
      SLEEP_SECONDS: "2"
    depends_on:
      postgres16:
        condition: service_healthy
    networks: [kafka-net]
    restart: "no"

  orders:
    build:
      context: .
      dockerfile: services/orders/Dockerfile
      target: orders-app
    container_name: orders
    environment:
      CONFIG_FILE: /app/config/config.yaml
    depends_on:
      postgres16:       { condition: service_healthy }
      redis:            { condition: service_healthy }
      kafka:            { condition: service_healthy }
      orders-migrate:   { condition: service_completed_successfully }
    ports:
      - "5083:8082"
      - "7072:7072"
    healthcheck:
      test: ["CMD", "sh", "-c", "nc -z 127.0.0.1 8082"]
      interval: 5s
      timeout: 3s
      retries: 15
    networks: [kafka-net]
    restart: unless-stopped

networks:
  kafka-net: {}
